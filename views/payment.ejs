<%- include('./partials/header.ejs')  %>
<%- include('./partials/navbar.ejs')  %>

<style>
@media (min-width : 992px) {
    .navbar {
        padding-right: 15px;
    }
}

.footer {
    display: none;
}
</style>

<div class="container payment-section">

    <div class="row align-items-center justify-content-between position-relative pb-5 pb-lg-0">
        <div class="col-12 col-lg-6 col-xl-6">
            <div class="col-12 d-flex align-items-center justify-content-between mb-3">
                <div>
                <h3>Onboarding</h3>
                <p class="text-body-secondary" style="font-size: calc(1rem + 0.2vw);">Get started your payment method</p>
                </div>

                <div class="progress-circle-wrapper text-center mt-4">
                    <div class="progress-circle position-relative mx-auto">
                      <svg width="100" height="100">
                        <circle class="bg" cx="50" cy="50" r="45" stroke-width="10" fill="none" />
                        <circle class="progress" cx="50" cy="50" r="45" stroke-width="10" fill="none" />
                      </svg>
                      <div class="progress-text position-absolute top-50 start-50 translate-middle">1/4</div>
                    </div>
                </div>

            </div>

            <div class="col-12 col-xl-10 position-relative payment-nav-steps" id="stepNav">
                <div class="col-12 d-flex align-items-center justify-content-between py-3 px-4 rounded-3 mb-1 mb-lg-3 mb-xl-4 payment-items active" data-index="0">
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="d-flex align-items-center justify-content-center rounded-circle bg-primary me-3 me-md-5" style="width: 50px;height: 50px;"><img class="w-50 h-50" src="/icons/primary-login.svg"></div>
                        <p class="mb-0 fs-5">Primary login</p>
                    </div>
                    <i class="bi bi-arrow-down-right fw-bold mt-1" style="transform: rotate(-45deg);"></i>
                </div>
                <div class="col-12 d-flex align-items-center justify-content-between py-3 px-4 rounded-3 mb-1 mb-lg-3 mb-xl-4 payment-items" data-index="1">
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="d-flex align-items-center justify-content-center rounded-circle bg-primary me-3 me-md-5" style="width: 50px;height: 50px;"><img class="w-50 h-50" src="/icons/payment-method.svg"></div>
                        <p class="mb-0 fs-5">Payment method</p>
                    </div>
                    <i class="bi bi-arrow-down-right fw-bold mt-1" style="transform: rotate(-45deg);"></i>
                </div>
                <div class="col-12 d-flex align-items-center justify-content-between py-3 px-4 rounded-3 mb-1 mb-lg-3 mb-xl-4 payment-items" data-index="2">
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="d-flex align-items-center justify-content-center rounded-circle bg-primary me-3 me-md-5" style="width: 50px;height: 50px;"><img class="w-50 mt-1" src="/icons/registration.svg"></div>
                        <p class="mb-0 fs-5">Registration</p>
                    </div>
                    <i class="bi bi-arrow-down-right fw-bold mt-1" style="transform: rotate(-45deg);"></i>
                </div>
                <div class="col-12 d-flex align-items-center justify-content-between py-3 px-4 rounded-3 mb-1 mb-lg-3 mb-xl-4 payment-items" data-index="3">
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="d-flex align-items-center justify-content-center rounded-circle bg-primary me-3 me-md-5" style="width: 50px;height: 50px;"><img class="w-50 h-50" src="/icons/transaction.svg"></div>
                        <p class="mb-0 fs-5">Transaction</p>
                    </div>
                    <i class="bi bi-arrow-down-right fw-bold mt-1" style="transform: rotate(-45deg);"></i>
                </div>

                <div class="bg-line z-n1"></div>
            </div>
        </div>
    
        <div class="col-12 col-lg-6 col-xl-5 px-lg-4 px-xxl-5 mb-5 mb-lg-0 h-100" id="stepContent">
            <div class="col-12 tab-pane fade show active mt-5" data-index="0">
                <div class="col-12 d-flex justify-content-center mb-4">
                    <img style="width: calc(110px + 6vw);" src="/icons/payment-logo.svg">
                </div>
    
                <div class="mb-3">
                    <label for="EmailFormInput" class="form-label">Email</label>
                    <input 
                    type="email" 
                    class="form-control border-0 rounded-2 bg-body-secondary bg-opacity-75 py-3" 
                    id="EmailFormInput"
                    name="email"
                    placeholder="Enter email"
                    required
                    >
                </div>
    
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <div class="position-relative">
                      <input 
                        type="password" 
                        class="form-control border-0 rounded-2 bg-body-secondary bg-opacity-75 py-3" 
                        id="password"
                        name="password"
                        placeholder="Enter your password" 
                        required
                      >
                      <i 
                        class="bi bi-eye position-absolute top-50 end-0 translate-middle-y me-3 toggle-icon text-body-secondary" 
                        id="toggleIcon" 
                        style="cursor: pointer;font-size: 1.5rem;"
                      ></i>
                    </div>
                </div>
    
                <div class="row g-2 mb-3">
                    <div class="col-12 col-md-6">
                        <button type="submit" class="btn btn-primary col-12 rounded-2" onclick="primaryLogin()"
                        style="padding-block: 0.7rem;">
                            Login account
                        </button>
                    </div>
                    <div class="col-12 col-md-6">
                        <button type="button" class="btn bg-body-secondary col-12 rounded-2"
                        style="padding-block: 0.7rem;">
                        <img src="/icons/google.svg" class="me-2"
                        style="width: 25px;height: 25px;">
                            Login with google
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-12 tab-pane fade mt-4" data-index="1">
                <h4>Choose payment method</h4>
                <p class="text-body-secondary" style="font-size: calc(1rem + 0.1vw);">The feature lets users select from multiple secure options: Bank Account for direct transfers, Easy Paisa for quick mobile payments, and Jazz Cash for instant transactions.</p>

                <div class="col-12 text-body-secondary" style="font-size: 1.1rem;">
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="radio" name="radioDefault" id="radioDefault1" checked>
                      <label class="form-check-label ms-2" for="radioDefault1">Credit & Debit card</label>
                    </div>
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="radio" name="radioDefault" id="radioDefault2">
                      <label class="form-check-label ms-2" for="radioDefault2">Easy Paisa</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="radioDefault" id="radioDefault3">
                      <label class="form-check-label ms-2" for="radioDefault3">Jazz Cash</label>
                    </div>
                </div>
            </div>

            <div class="col-12 tab-pane fade CreaditCard" data-index="2">
                <div class="row g-2">
                    <div class="col-12 col-lg-8 mb-3">
                        <label for="CardNameFormInput" class="form-label">Card Name</label>
                        <input 
                        type="text" 
                        class="form-control border-0 rounded-2 bg-body-secondary bg-opacity-75 py-3" 
                        id="CardNameFormInput"
                        placeholder="Enter Card Name"
                        required>
                    </div>

                    <% let priceToUse = typeof totalPrice !== 'undefined' ? totalPrice : (typeof course !== 'undefined' ? course.price : 0); %>

                    <div class="col-12 col-lg-4 mb-3">
                        <label for="AmmountFormInputCard" class="form-label">Total Amount</label>
                        <input 
                          type="text" 
                          class="form-control border-0 rounded-2 bg-body-secondary bg-opacity-75 py-3 convertedAmountPKR"
                          data-usd="<%= priceToUse %>"
                          placeholder="₨0 PKR"
                          readonly>
                    </div>
                    
                </div>
                <div class="col-12 mb-3">
                    <label for="CardNumberFormInput" class="form-label">Card Number</label>
                    <input 
                    type="text" 
                    class="form-control border-0 rounded-2 bg-body-secondary bg-opacity-75 py-3" 
                    id="CardNumberFormInput"
                    placeholder="Enter Card Number"
                    required>
                </div>

                <div class="row g-2">
                    <div class="col-12 col-lg-6 mb-3">
                        <label for="DateFormInput" class="form-label">Expiry Date</label>
                        <input 
                        type="text" 
                        class="form-control border-0 rounded-2 bg-body-secondary bg-opacity-75 py-3" 
                        id="DateFormInput"
                        placeholder="MM / YY"
                        required>
                    </div>
                    <div class="col-12 col-lg-6 mb-3">
                        <label for="DateFormInput" class="form-label">CVC / CVV</label>
                        <input 
                        type="text" 
                        class="form-control border-0 rounded-2 bg-body-secondary bg-opacity-75 py-3" 
                        id="CVCFormInput"
                        placeholder="CVC"
                        required>
                    </div>
                </div>

                <div class="form-check text-body-secondary">
                    <input class="form-check-input" type="checkbox" value="" id="checkDefault">
                    <label class="form-check-label ms-2" for="checkDefault">Securely save this card for my later purchase</label>
                </div>

            </div>

            <div class="col-12 Easypaisa">
                <div class="row g-2">
                    <div class="col-12 col-lg-8 mb-3">
                        <label for="BankFormInput" class="form-label">Branch Name</label>
                        <input 
                        type="text" 
                        class="form-control border-0 rounded-2 bg-body-secondary bg-opacity-75 py-3" 
                        id="BankFormInput"
                        placeholder="Habib Bank Limited"
                        readonly>
                    </div>

                    <div class="col-12 col-lg-4 mb-3">
                        <label for="AmmountFormInputEasy" class="form-label">Total Amount</label>
                        <input 
                          type="text" 
                          class="form-control border-0 rounded-2 bg-body-secondary bg-opacity-75 py-3 convertedAmountPKR"
                          data-usd="<%= priceToUse %>"
                          placeholder="₨0 PKR"
                          readonly>
                    </div>
                </div>
                <div class="col-12 mb-3">
                    <label for="ibanFormInput" class="form-label">IBAN Number</label>
                    <input 
                    type="text" 
                    class="form-control border-0 rounded-2 bg-body-secondary bg-opacity-75 py-3" 
                    id="ibanFormInput"
                    placeholder="PK012345678901"
                    readonly>
                </div>

                <div class="row g-2">
                    <div class="col-12 col-lg-6 mb-3">
                        <label for="AccountNameFormInput" class="form-label">Your Name</label>
                        <input 
                        type="text" 
                        class="form-control border-0 rounded-2 bg-body-secondary bg-opacity-75 py-3" 
                        id="AccountNameFormInput"
                        name="AccountNameFormInput"
                        placeholder="Enter Your Name"
                        required>
                    </div>
                    <div class="col-12 col-lg-6 mb-3">
                        <label for="AccountFileInput" class="form-label">Transaction</label>
                        <input 
                            type="file" 
                            class="form-control py-3" 
                            id="AccountFileInput"
                            name="AccountFileInput"
                            required>
                    </div>

                </div>

                <div class="col-12 mb-3">
                    <div class="col-12">
                        <label for="AccountNumberFormInput" class="form-label">Easypaisa & Jazzcash</label>
                        <input 
                        type="text" 
                        class="form-control border-0 rounded-2 bg-body-secondary bg-opacity-75 py-3" 
                        id="AccountNumberFormInput"
                        name="AccountNumberFormInpu"
                        placeholder="Enter Your Easypaisa & Jazzcash Number"
                        required>
                    </div>
                </div>
            </div>

            <div class="col-12 tab-pane fade text-center mt-3 mt-lg-0" data-index="3">
                <div class="col-12 d-flex justify-content-center mb-2">
                    <img style="width: calc(70px + 1vw);" src="/icons/transaction-complete.svg">
                </div>
                <h1 class="text-primary mb-3">THANKS</h1>
                <h4 class="text-body-secondary">Transaction complete successfully</h4>
            </div>

            
        </div>

        <div class="col-12 col-lg-6 col-xl-5 d-flex align-items-center justify-content-between position-absolute bottom-0 end-0 py-4">
            <div id="prevStep">
                <div class="d-flex align-items-center justify-content-center rounded-circle border border-2 border-dark-subtle" style="width: 50px;height: 50px;cursor: pointer;">
                    <i class="bi bi-arrow-left fs-5 text-body-tertiary"></i>
                </div>
            </div>
            <button id="nextStep" type="submit" class="btn btn-primary px-4 py-2">Next</button>
        </div>
    </div>

</div>

<script>
    $(document).ready(function () {
      $('#toggleIcon').click(function () {
        const passwordInput = $('#password');
        const inputType = passwordInput.attr('type') === 'password' ? 'text' : 'password';
        passwordInput.attr('type', inputType);
        $(this).toggleClass('bi-eye bi-eye-slash');
      });
    });
</script>

<script>
    let currentStep = 0;

    // Simulated user login data (replace with real backend logic as needed)
    const user = {
        email: `<%= user.email %>`,
    };

    function updateStepUI() {
        const steps = $('.payment-items');
        const tabs = $('.tab-pane');

        // Hide all steps
        steps.removeClass('active').hide();
        tabs.removeClass('show active').hide();

        // Step 3 = Final step (show only that)
        if (currentStep === 3) {
            steps.eq(3).addClass('active').show();
            tabs.eq(3).addClass('show active').show();
            $('#nextStep').hide();
            $('#prevStep').show();
        } else {
            // Show current step normally
            steps.eq(currentStep).addClass('active').show();
            tabs.eq(currentStep).addClass('show active').show();

            // Toggle button visibility
            if (currentStep === 0) {
                $('#nextStep, #prevStep').hide();
            } else {
                $('#nextStep, #prevStep').show();
            }

            // Step 2 = Show Pay Now
            if (currentStep === 2) {
                $('#nextStep')
                    .text('Pay Now')
                    .attr('onclick', 'proceedPayment()');
            } else {
                $('#nextStep')
                    .text('Next')
                    .removeAttr('onclick');
            }
        }

        // Hide both payment input areas first
        $('.CreaditCard, .Easypaisa').hide();

        // Show relevant payment section if on step 2
        if (currentStep === 2) {
            const selected = $('input[name="radioDefault"]:checked').attr('id');
            if (selected === 'radioDefault1') {
                $('.CreaditCard').show();
            } else {
                $('.Easypaisa').show();
            }
        }

        updateProgressCircle(currentStep);
    }

    function validateStep(step) {
        if (step === 1) {
            if (!$('input[name="radioDefault"]:checked').length) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Wait!',
                    text: 'Please select a payment method.'
                });
                return false;
            }
        }

        if (step === 2) {
            const selected = $('input[name="radioDefault"]:checked').attr('id');

            if (selected === 'radioDefault1') {
                const name = $('#CardNameFormInput').val().trim();
                const number = $('#CardNumberFormInput').val().trim();
                const expiry = $('#DateFormInput').val().trim();
                const cvc = $('#CVCFormInput').val().trim();

                if (!name || !number || !expiry || !cvc) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Missing Fields',
                        text: 'Please fill in all credit card details.'
                    });
                    return false;
                }
            } else {
                const easypaisaFields = $('.Easypaisa input[required]');
                let allFilled = true;

                easypaisaFields.each(function () {
                    if ($(this).val().trim() === '') {
                        allFilled = false;
                        return false;
                    }
                });

                if (!allFilled) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Missing Info',
                        text: 'Please fill in all Easypaisa or Jazzcash details.'
                    });
                    return false;
                }
            }
        }

        return true;
    }

    function primaryLogin() {
        const email = $('#EmailFormInput').val().trim();
        const password = $('#password').val();

        if (!email || !password) {
            Swal.fire({
                icon: 'warning',
                title: 'Oops!',
                text: 'Please enter email and password.'
            });
            return;
        }

        if (email === user.email) {
            currentStep = 1; // Skip to step 2 after successful login
            updateStepUI();
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Credentials',
                text: 'The email or password you entered is incorrect.'
            });
        }
    }

    $('#nextStep').on('click', function () {
        if (!validateStep(currentStep)) return;

        const totalSteps = $('.payment-items').length;
        if (currentStep < totalSteps - 1) {
            currentStep++;
            updateStepUI();
        }
    });

    $('#prevStep').on('click', function () {
        if (currentStep > 0) {
            currentStep--;
            updateStepUI();
        }
    });

    $(document).ready(function () {
        $('.payment-items').hide();
        $('.CreaditCard, .Easypaisa').hide();

        $('input[name="radioDefault"]').on('change', function () {
            if (currentStep === 2) {
                const selected = $(this).attr('id');
                if (selected === 'radioDefault1') {
                    $('.CreaditCard').show();
                    $('.Easypaisa').hide();
                } else {
                    $('.CreaditCard').hide();
                    $('.Easypaisa').show();
                }
            }
        });

        updateStepUI();
    });

    function updateProgressCircle(step) {
        const totalSteps = 4;
        const percentage = ((step + 1) / totalSteps) * 100;

        const circle = document.querySelector('.progress-circle .progress');
        const label = document.querySelector('.progress-text');
        const radius = 45;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (percentage / 100) * circumference;

        circle.style.strokeDashoffset = offset;
        label.textContent = `${step + 1}/${totalSteps}`;
    }
</script>

<script>
    $(document).ready(function () {
      function updateLabelColor() {
        $('input[name="radioDefault"]').each(function () {
          const label = $('label[for="' + this.id + '"]');
          if ($(this).is(':checked')) {
            label.removeClass('text-body-secondary').addClass('text-primary');
          } else {
            label.removeClass('text-primary').addClass('text-body-secondary');
          }
        });
      }
  
      // Initial check on page load
      updateLabelColor();
  
      // Listen for change events
      $('input[name="radioDefault"]').change(function () {
        updateLabelColor();
      });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get all elements with class 'convertedAmountPKR'
        const pkrElements = document.querySelectorAll('.convertedAmountPKR');

        // Loop through each element to apply the conversion
        pkrElements.forEach(function(element) {
            const usdAmount = parseFloat(element.getAttribute('data-usd')); // Get USD amount from the data-usd attribute

            // Call Exchange Rate API to get USD to PKR rate
            fetch('https://api.exchangerate-api.com/v4/latest/USD')
                .then(response => response.json())
                .then(data => {
                    const usdToPkrRate = data.rates.PKR; // Get PKR rate
                    const convertedAmount = Math.round(usdAmount * usdToPkrRate).toLocaleString('en-PK');

                    // Update the PKR input field with the converted value
                    element.value = `₨${convertedAmount}`;
                })
                .catch(error => {
                    console.error('Error fetching exchange rate:', error);
                    element.value = 'Error fetching PKR';
                });
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
      const pkrFields = document.querySelectorAll('.convertedAmountPKR');
  
      fetch('https://api.exchangerate-api.com/v4/latest/USD')
        .then(res => res.json())
        .then(data => {
          const rate = data.rates.PKR;
  
          pkrFields.forEach(field => {
            const usd = parseFloat(field.dataset.usd);
            if (!isNaN(usd)) {
              const pkr = Math.round(usd * rate).toLocaleString('en-PK');
              field.value = `₨${pkr}`;
            } else {
              field.value = '₨0';
            }
          });
        })
        .catch(err => {
          console.error("Exchange rate fetch error:", err);
          pkrFields.forEach(field => {
            field.value = 'Error fetching PKR';
          });
        });
    });
</script>
  

  
<%- include('./partials/footer.ejs')  %>